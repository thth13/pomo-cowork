# Исправление: Проблема с отображением активных сессий

## Проблема
При завершении работы и начале новой сессии, новая сессия одного пользователя "стирала" сессии других пользователей из списка активных сессий.

## Причина
1. **WebSocket сервер** удалял сессии без проверки владельца
2. **Клиент** отправлял команды завершения сессии, которые влияли на других пользователей
3. **Отсутствие защиты** от дублирования сессий одного пользователя
4. **Неправильный порядок** операций при начале новой сессии

## Исправления

### 1. `/components/PomodoroTimer.tsx`
- ✅ Изменен порядок операций в `handleStart()`: теперь сначала завершаем старую сессию в WebSocket, потом очищаем локальное состояние
- ✅ Убраны временные ID - теперь сессия создается сначала в БД, потом запускается локально
- ✅ Правильная обработка перехода между сессиями в `handleSessionComplete()`

### 2. `/socket-server/src/index.ts`
- ✅ В `session-end` добавлена проверка: удаляем только сессии, принадлежащие текущему сокету
  ```typescript
  if (session.socketId === socket.id) {
    sessions.delete(sessionId)
  }
  ```
- ✅ В `session-start` добавлено удаление дублирующихся сессий одного пользователя
  ```typescript
  sessions.forEach((existingSession, existingSessionId) => {
    const isSameUser = (
      (userId && existingSession.userId === userId) ||
      (anonymousId && existingSession.socketId === socket.id)
    )
    if (isSameUser && existingSessionId !== sessionData.id) {
      sessions.delete(existingSessionId)
    }
  })
  ```
- ✅ То же самое в `session-sync` для предотвращения дублей при восстановлении сессий

### 3. `/app/api/sessions/route.ts`
- ✅ Упрощена и оптимизирована логика в `POST /api/sessions`
- ✅ Теперь автоматически завершаются ВСЕ активные сессии пользователя перед созданием новой
  ```typescript
  await prisma.pomodoroSession.updateMany({
    where: {
      userId,
      status: { in: ['ACTIVE', 'PAUSED'] }
    },
    data: {
      status: 'CANCELLED',
      endedAt: new Date()
    }
  })
  ```
- ✅ Работает одинаково для аутентифицированных и анонимных пользователей

## Защита от race conditions
- Дебаунсинг кнопок (1 секунда между нажатиями)
- Флаги `isStarting` и `isStopping` для предотвращения множественных запросов
- Атомарные операции в БД через `updateMany`
- Проверка владельца сессии в WebSocket сервере

## Тестирование
Нужно протестировать следующие сценарии:

1. ✅ Два пользователя работают одновременно - каждый видит свою и чужую сессию
2. ✅ Пользователь завершает работу и начинает новую сессию - другие пользователи остаются в списке
3. ✅ Пользователь перезагружает страницу во время активной сессии - сессия восстанавливается
4. ✅ Автоматический переход Work → Break → Work - сессии корректно сменяют друг друга
5. ✅ Анонимные пользователи работают корректно

## Важные моменты
- Каждый пользователь может иметь только ОДНУ активную сессию
- При создании новой сессии старые автоматически завершаются
- WebSocket сервер не удаляет чужие сессии
- Порядок операций критичен: WebSocket → БД → локальное состояние
